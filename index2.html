<!DOCTYPE html>
<html>
<head></head>
<body>


<button id="run_selection" onclick="run_selection()">run_selection</button>


<div id="data_display" style="display:block; text-align: left; width: 600px;"></div>
<canvas class="canvasElement_className" id="canvasElement_id" width="256" height="256" style="display:block"></canvas>
<div class="obj_className" id="obj_div" style="display:none"></div>


<!-- ---------------------------------------- -->
	
<script src="./cfg/main.js" type="text/javascript"></script>

<!-- ---------------------------------------- -->
  
<script>

// -------------------------------------------------

window.addEventListener('beforeunload', function() {
	window.location.href = window.location.href + '?nocache=' + new Date().getTime();
});

// -------------------------------------------------
	
var width = 256;
var height = 256;

// -----------------------------------------------
  
async function run_selection() {

console.time('run_selection');
	
	// Canvas to obtain data from.
	// Only HTML elements function.
	var canvasElement = document.getElementById('canvasElement_id');
	document.getElementById('canvasElement_id').style.border = '1px solid black';
	var ctx = canvasElement.getContext("2d");
		    
	// --------------------

	// Prints original image to canvas, without parallel processing result.
	await create_a_solid_image(ctx);

	// --------------------

	// Obtain canvas data as an array
	const normalArray = await convert_canvas_into_ImageData(ctx);

	// --------------------

	// Modify the canvas image data 
	const Typedarray = await modify_canvas_data(normalArray);

	// --------------------
	
	// Output data to main.js
	const file_name = "retrieve_image.js";
	const payload = {data: Typedarray, type: 'process'};
	document.getElementById("obj_div").innerHTML = JSON.stringify({ file_name: file_name, payload: payload});

	// --------------------

	// Call main.js
	const mainScript = document.createElement('script');
	mainScript.src = './cfg/main.js';
	document.body.appendChild(mainScript);
	
	// --------------------
	
	console.timeEnd('run_selection');

}

// -------------------------------------------------







// -----------------------------------------------
// SUBFUNCTIONS
// -----------------------------------------------
async function create_a_solid_image(ctx) {
	
	var r = Math.floor(Math.random()*255);
	var g = Math.floor(Math.random()*255);
  	var b = Math.floor(Math.random()*255);
  	const alpha = Math.floor(Math.random()*100);
  
  	// ----------------------
  
  	// Make r, g, b and interesting color range.
	// Make r from 1 to 255 if r>1, then output=r else output=1
	r = r>0 ? r : 1;
	g = g>0 ? g : 1;
	b = b>0 ? b : 1;

	// ----------------------
	
	ctx.fillStyle = `rgb(${r} ${g} ${b} / ${alpha}%)`;
	ctx.fillRect(0, 0, width, height);
}

// -------------------------------------------------

async function convert_canvas_into_ImageData(ctx) {
	
	// Get canvas image
	const uint8ClampedArray = await ctx.getImageData(0, 0, width, height); // TypedArray  Uint8ClampedArray
	// console.log('uint8ClampedArray: ', uint8ClampedArray);
  
	// Convert TypedArray to normalArray
	return normalArray = await Array.from(uint8ClampedArray.data);
}

// -------------------------------------------------

async function modify_canvas_data(normalArray) {

	// Modify some of the pixels, to determine if there is a change
	const color_name = ['r', 'g', 'b', 'alpha'];
	for ( let i=0; i<normalArray.length; i+=color_name.length ) {
		if ( i > normalArray.length/2 && i % 2 == 0) {
			normalArray[i] = 255;
			normalArray[i+1] = 255;
			normalArray[i+2] = 255;
		}
	}

	return await new Uint8ClampedArray(normalArray);
}

// -------------------------------------------------


</script>
</body>
</html>
